# 锁

## `synchronized` 和 `ReentrantLock` 的区别，如何选择

synchronized是java中的关键字，用于实现多线程下同步功能，ReentrantLock是java自带的api包中的类，也可以实现多线程下同步功能

多线程竞争时，synchronized不可以中断，而ReentrantLock可以调用中断方法或者根据等待时间进行中断，减少了出现死锁的可能性

synchronized是非公平锁，而ReentrantLock可根据不同的情形设置是否是公平锁

synchronized会根据线程竞争程度，从偏向锁，轻量级锁，重量级锁进行升级，到重量级锁时，会阻塞线程，ReentrantLock的核心类Sync实现了AQS，是通过自旋CAS操作实现同步功能，不会阻塞线程

通常情况下建议使用synchronized，如果有需要使用公平锁，中断等待等情形，建议使用ReentrantLock

## synchronized升级

锁升级的方向是无锁->偏向锁->轻量级锁->重量级锁

当只有一个线程访问同步代码块时，会将线程ID通过CAS置换进对象头中，此时是偏向锁上锁，后续如果同一线程重复访问代码块，无需进行CAS，只需简单比较对象中的线程ID是否相同即可，偏向锁的撤销会在一个安全点，对持有锁的线程暂停，并校验锁对象是否确实处于被锁定状态

当处于偏向锁状态时，有第二个线程访问同步代码块，首先判断是否是无锁情况，如果是，则升级为偏向锁，如果否，执行CAS置换线程ID，如果成功，则第二个线程获取偏向锁，如果失败就会开始撤销偏向锁，并检查持有偏向锁的线程是否已经退出同步代码块，如果已经退出，则

如果轻量级锁CAS自旋次数超过阈值，则会升级到重量级锁，阻塞当前线程
